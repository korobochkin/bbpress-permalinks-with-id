name: Release

on:
  release:
    types:
      - published

concurrency:
  group: release
  cancel-in-progress: false

permissions: {}

jobs:
  precheck:
    name: 'Precheck'
    runs-on: ubuntu-latest
    if: ${{ !github.event.release.prerelease && github.ref_type == 'tag' }}
    outputs:
      version: ${{ steps.find-version.outputs.version }}
    steps:
      - name: 'Find version'
        id: find-version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

  tests:
    name: 'Tests'
    uses: ./.github/workflows/tests.yml
    needs:
      - precheck
    permissions:
      contents: read

  plugin-check:
    name: 'Plugin Check'
    uses: ./.github/workflows/plugin-check.yml
    needs:
      - precheck
    permissions:
      contents: read

  deploy:
    name: 'Deploy'
    runs-on: ubuntu-latest
    needs:
      - precheck
      - tests
      - plugin-check
    permissions:
      contents: read
    environment: 'WordPress.org'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy to WordPress.org
        uses: 10up/action-wordpress-plugin-deploy@stable
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
          SLUG: ${{ vars.SLUG }}
          VERSION: ${{ needs.precheck.outputs.version }}
          INPUT_DRY_RUN: ${{ vars.INPUT_DRY_RUN }}
          INPUT_GENERATE_ZIP: ${{ vars.INPUT_GENERATE_ZIP }}
